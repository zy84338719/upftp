name: Build and Release

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  GO_VERSION: 1.21

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: Run tests
      run: make test

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # è·å–å®Œæ•´çš„gitå†å²ç”¨äºç‰ˆæœ¬æ ‡ç­¾
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: Download dependencies
      run: make deps
      
    - name: Build all platforms
      run: make build-all
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: binaries
        path: dist/

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: Download dependencies
      run: make deps
      
    - name: Create release packages
      run: make package
      
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: UPFTP ${{ github.ref_name }}
        body: |
          ## ğŸš€ UPFTP ${{ github.ref_name }}
          
          ### ä¸‹è½½è¯´æ˜
          
          è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ï¼š
          
          #### Linux
          - `upftp_${{ github.ref_name }}_linux_amd64.tar.gz` - Linux 64ä½ (Intel/AMD)
          - `upftp_${{ github.ref_name }}_linux_arm64.tar.gz` - Linux ARM64 (å¦‚æ ‘è“æ´¾ç­‰)
          
          #### macOS
          - `upftp_${{ github.ref_name }}_darwin_amd64.tar.gz` - macOS Intel å¤„ç†å™¨
          - `upftp_${{ github.ref_name }}_darwin_arm64.tar.gz` - macOS Apple Silicon (M1/M2)
          
          #### Windows
          - `upftp_${{ github.ref_name }}_windows_amd64.zip` - Windows 64ä½
          - `upftp_${{ github.ref_name }}_windows_386.zip` - Windows 32ä½
          
          ### å¿«é€Ÿå¼€å§‹
          
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…
          2. è§£å‹ç¼©æ–‡ä»¶
          3. åœ¨ç»ˆç«¯ä¸­è¿è¡Œç¨‹åº
          
          ```bash
          # Linux/macOS
          ./upftp
          
          # Windows
          upftp.exe
          ```
          
          ### æ–°ç‰¹æ€§
          - ğŸŒ ç°ä»£åŒ–Webç•Œé¢
          - ğŸ¥ è§†é¢‘å’ŒéŸ³é¢‘æ–‡ä»¶é¢„è§ˆ
          - ğŸ“ FTPæœåŠ¡å™¨æ”¯æŒ
          - ğŸ” å®æ—¶æ–‡ä»¶æœç´¢
          - ğŸ“± ç§»åŠ¨è®¾å¤‡é€‚é…
          
          å®Œæ•´æ–‡æ¡£è¯·æŸ¥çœ‹ [INSTALL.md](INSTALL.md)
          
        draft: false
        prerelease: false
        
    - name: Upload Release Assets
      run: |
        for file in releases/*; do
          echo "Uploading $file"
          gh release upload ${{ github.ref_name }} "$file"
        done
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
